F.module("pack:mods/new_weather_setting",function(d,N,u){var g=u.base,s=d("mods/basic"),P=d("tpl/new_weather"),r=d("mods/weather_city"),E=d("mods/new_weather"),a=d("common/tween").Class;d("tpl_new_weather_setting.css");var c=["日","一","二","三","四","五","六"];var V,q,H,j,I,l,f,v,J,m,t,O,R,K="<div style='line-height:114px;text-align:center'>请先设置城市信息</div>",B="_"+s_session.portrait+"_new_weather_bear_day",C="a2",y=false;var p=g.q("s-pk-new-weather",g.g("s_modules"))[0],k=0,n=0,L=false,b=false;var X=s_domain.baseuri+"/pack/data/content?id=",A=s_domain.baseuri+"/pack/submit/modify";function W(){clearTimeout(n);k=setTimeout(function(){clearTimeout(E.refreshTimer);g.dom.toggleClass(q,"____refreshforIe___");if(g.getStyle(q,"display")=="none"){u.fire("guideShown",{prop:"newWeatherDetail"})}o()},300)}function e(){if(L){return}clearTimeout(k);n=setTimeout(function(){z();i();E.refreshWeather()},200)}function o(){if(y){return}if(g.isIE6){g.setStyle(q,"display","block");g.setStyle(t,"top","0px");g.setStyle(O,"top","0px");g.setStyle(R,"display","block");b=true;return}g.setStyle(q,"display","block");if(t&&O&&R){if(!b){y=true;g.setStyle(O,"top","0px");g.setStyle(t,"top","0px");g.setStyle(R,"display","block");y=false;b=true}}else{t=g.q("s-new-weather-move_pnl",q)[0];O=g.q("s-new-weather-move-bg",q)[0];R=g.q("s-new-weather-shadow-box",q)[0];if(t&&O&&R){o()}else{return}}}function i(){if(y){return}if(g.isIE6){g.setStyle(q,"display","none");g.setStyle(R,"display","none");g.setStyle(O,"top","0px");g.setStyle(t,"top","0px");b=false;return}if(t&&O&&R){if(b){y=true;g.setStyle(R,"display","none");g.setStyle(O,"top","-215px");g.setStyle(t,"top","-215px");g.setStyle(q,"display","none");y=false;b=false}}else{t=g.q("s-new-weather-move_pnl",q)[0];O=g.q("s-new-weather-move-bg",q)[0];R=g.q("s-new-weather-shadow-box",q)[0];if(t&&O&&R){i()}else{q&&g.setStyle(q,"display","none");return}}}var D=function(){var Y=["<div class='weather-item weather-today'>","<div class='weather-day'>#{todayday}</div>","<a id='new_weather_today_set_link' class='new-weather-link' target='_blank' href='#{searchPageLink}'>","#{todayMorningImgSrc}","<p class='weather-temp'>#{todaytemp}</p>","<p class='weather-condition' title='#{todaycondition}'>#{todaycondition}</p>","<p class='weather-wind'>#{todaywind}</p></a>","</div>","<div class='weather-item weather-tomorrow'>","<div class='weather-day'>#{tomorrowday}</div>","<a id='new_weather_tomorrow_set_link' class='new-weather-link' target='_blank' href='#{searchPageLink}'><img class='weather-img' src='#{tomorrowimgSrc}'>","<p class='weather-temp'>#{tomorrowtemp}</p>","<p class='weather-condition' title='#{tomorrowcondition}'>#{tomorrowcondition}</p>","<p class='weather-wind'>#{tomorrowwind}</p></a>","</div>","<div class='weather-item'>","<div class='weather-day'>#{thirddayday}</div>","<a id='new_weather_thirdDay_set_link' class='new-weather-link' target='_blank' href=#{searchPageLink}><img class='weather-img' src='#{thirddayimgSrc}'>","<p class='weather-temp'>#{thirddaytemp}</p>","<p class='weather-condition' title='#{thirddaycondition}'>#{thirddaycondition}</p>","<p class='weather-wind'>#{thirddaywind}</p></a>","</div>"];if(V&&V.cityname){var aa=V.weatherType?V.weatherType:"png";var ac=".su.bdimg.com/icon/weather/"+(aa=="png"?"48_48":(aa+"/jpg"))+"/",Z=function(ad){var ae=(ad?ad:"a2").slice(1);if(isNaN(ae)||ae.length<1){return 1}else{return(parseInt(ae)%8+1)}},S=new Date(sysTime*1000);V.todayday="今天(周"+c[S.getDay()]+(V.today.rtt?","+V.today.rtt:"")+")";V.tomorrowday="明天(周"+c[(S.getDay()+1)%7]+")";V.thirddayday="后天(周"+c[(S.getDay()+2)%7]+")";if(S.getHours()>=18&&(V.today.imgs[0]=="a0"||V.today.imgs[0]=="a1")){V.today.imgs[0]=V.today.imgs[0]+"_night"}V.todayMorningImgSrc='<img class="weather-img" src="http://'+Z(V.today.imgs[0])+ac+(V.today.imgs[0]?V.today.imgs[0]:C)+'.jpg">';V.tomorrowimgSrc="http://"+Z(V.tomorrow.imgs[0])+ac+(V.tomorrow.imgs[0]?V.tomorrow.imgs[0]:C)+".jpg";V.thirddayimgSrc="http://"+Z(V.thirdday.imgs[0])+ac+(V.thirdday.imgs[0]?V.thirdday.imgs[0]:C)+".jpg";V.todaytemp=V.today.temp;V.tomorrowtemp=V.tomorrow.temp;V.thirddaytemp=V.thirdday.temp;V.todaywind=V.today.wind;V.tomorrowwind=V.tomorrow.wind;V.thirddaywind=V.thirdday.wind;V.todaycondition=V.today.condition;V.tomorrowcondition=V.tomorrow.condition;V.thirddaycondition=V.thirdday.condition;V.todaylink=V.today.link;V.tomorrowlink=V.tomorrow.link;V.thirddaylink=V.thirdday.link;V.searchPageLink=V.pslink;g.q("weather-detail",q)[0].innerHTML=g.format(Y.join(""),V)}else{g.q("weather-detail",q)[0].innerHTML=K}var ab=function(){if(g.g("new_weather_today_set_link")){g.on(g.g("new_weather_today_set_link"),"click",function(){u.fire("weatherClick",{clickType:"weatherIcon",whichDay:"today"})})}if(g.g("new_weather_tomorrow_set_link")){g.on(g.g("new_weather_tomorrow_set_link"),"click",function(){u.fire("weatherClick",{clickType:"weatherIcon",whichDay:"tomorrow"})})}if(g.g("new_weather_thirdDay_set_link")){g.on(g.g("new_weather_thirdDay_set_link"),"click",function(){u.fire("weatherClick",{clickType:"weatherIcon",whichDay:"threeDay"})})}};ab()};var h=function(){var aa={pnl:"weather-set-pnl",prov:"weather-set-prov",city:"weather-set-city",ok:"pk-btn-ok",cancel:"pk-btn-cl",text:"pk-text-select",err:"weather-i-err"};var ac="<a href='#' onclick='return false;' class='#{btn}' hidefocus>#{text}</a>",Y="<option value='#{value}'#{op}>#{value}</option>";function S(ad){if(ad){return ad.replace("天气","")}return ad}var Z=function(){var ah=S(J),af=r.findProv(ah),ae="自动",ag=(af?(af=="加载中..."?[ah]:r.City[af]):[ae]);if(!af){af=ae}if(!ah){ah=ag[0]}var ad=[],ai=Y;ad.push("<div class='"+aa.pnl+"'>");ad.push("<div class='set-label'>选择您所在的地区：</div>");ad.push("<select class='weather-option "+aa.prov+"'>");ad.push(g.format(ai,{value:ae,op:(ae==af?" selected='selected'":"")}));g.object.each(r.City,function(ak,aj){ad.push(g.format(ai,{value:aj,op:(aj==af?" selected='selected'":"")}))});ad.push("</select>");ad.push("<select name='city' class='weather-option "+aa.city+"'>");g.each(ag,function(aj){ad.push(g.format(ai,{value:aj,op:(aj==ah?" selected='selected'":"")}))});ad.push("</select>");ad.push("<br/>");ad.push(g.format(ac,{btn:aa.ok,text:"保存"}));ad.push(g.format(ac,{btn:aa.cancel,text:"取消"}));ad.push("</div>");return ad.join("")};var ab=function(){var ad=g.q("weather-set-pnl",q)[0];var ae=g.q(aa.prov,ad)[0];if(ae){g.on(ae,"change",function(){var ag=ae.value,ai=["自动"],af=[],aj=Y,ah=g.q(aa.city,ad)[0];if(ag&&(ag!="自动")){ai=r.City[ag]}ah.length=0;g.each(ai,function(al,ak){ah.options.add(new Option(al,al,ak==0))})});g.on(g.q(aa.ok,ad)[0],"click",function(ag){var af=g.q(aa.city,ad)[0].value||"自动";g.post(A,"cmd=settq&id="+v+"&city="+(af=="自动"?af:af+"天气"),function(ah){if(ah.errNo!=0){return}v=ah.data.id;N.refresh()})});g.on(g.q(aa.cancel,ad)[0],"click",function(af){z();g.setStyle(q,"display","none")});g.each(g.q("weather-option",q),function(af){g.on(af,"focus",function(ag){L=true});g.on(af,"blur",function(ag){L=false})})}};g.q("weather-setting",q)[0].innerHTML=Z();ab()};var U=function(){var S=["<div id='new_weather_calendar_detail' class='calendar-detail'>","<span class='calendar-gregorian' target='_blank' href=''>#{nowTime}</span>","<a class='calendar-lunar' target='_blank' href='http://www.baidu.com/s?wd=%E5%86%9C%E5%8E%86'>#{nowLunar}</a>","<a class='calendar-solar-term' target='_blank' href='http://www.baidu.com/s?wd=%E5%86%9C%E5%8E%86'>#{nowFestival}</a>","<a class='calendar-seven-day' target='_blank' href='#{nowSourceUrl}'>#{sevenDayContent}</a>","</div>"];if(V.today){var ab={},Y=new Date(),aa=0;if(V.calendar&&V.calendar.time&&+V.calendar.time>0){Y.setTime(V.calendar.time);aa=parseInt(Y.getMonth())+1;ab.nowTime=((aa<10)?"0":"")+aa+"月"+(Y.getDate()<10?"0":"")+Y.getDate()+"日";ab.sevenDayContent="未来七天预报"}else{ab.nowTime="";ab.sevenDayContent=""}ab.nowLunar=(V.calendar&&V.calendar.lunar)?("农历"+V.calendar.lunar):"";ab.nowFestival=(V.calendar&&V.calendar.festival&&V.calendar.festival!="")?"( "+V.calendar.festival+")":"";ab.nowSourceUrl=(V.calendar&&V.calendar.weatherSourceUrl)?V.calendar.weatherSourceUrl:"";g.q("pnl-calendar",q)[0].innerHTML=g.format(S.join(""),ab);ab=null}else{}var Z=function(){var ac=g.q("calendar-lunar",g.g("new_weather_calendar_detail"))[0],ae=g.q("calendar-solar-term",g.g("new_weather_calendar_detail"))[0],ad=g.q("calendar-seven-day",g.g("new_weather_calendar_detail"))[0];if(ac){g.on(ac,"click",function(){u.fire("weatherClick",{clickType:"lunar"})})}if(ae){g.on(ae,"click",function(){u.fire("weatherClick",{clickType:"lunar"})})}if(ad){g.on(ad,"click",function(){u.fire("weatherClick",{clickType:"sevenDayWeather"})})}};Z()};var Q=function(){var S=["<div class='personal-detail'>","<input type='checkbox' id='s_new_weather_psnal_bear' "+((s_session.userTips.weatherShowBear=="on"||s_session.userTips.weatherShowBear+""=="true")?"checked":"")+" onfocus='blur()'/>","<label for='s_new_weather_psnal_bear' onfocus='blur()'>显示天气小熊</label>","#{PolutionCheckbox}","</div>"];if(V.today&&V.today.pollution&&+V.today.pollution>=0){V.PolutionCheckbox="<input type='checkbox' id='s_new_weather_psnal_air' "+((s_session.userTips.weatherSetPolution=="on"||s_session.userTips.weatherSetPolution+""=="true")?"checked":"")+" onfocus='blur()'/><label for='s_new_weather_psnal_air' class='personal-detail-label-last' onfocus='blur()'>显示空气质量</label>"}else{V.PolutionCheckbox=""}g.q("pnl-personal-set",q)[0].innerHTML=g.format(S.join(""),V);var Y=function(){var Z=g.q("personal-detail",q)[0];g.on(Z,"click",function(ac){var ab=g.event.getTarget(window.event||ac);if(ab.id&&(ab.id.indexOf("s_new_weather_psnal")>=0)){switch(ab.id){case"s_new_weather_psnal_air":var aa=g.g("s_new_weather_psnal_air").checked?"on":"off";F.getService("superpage","userAttr",function(ae){ae.setAttr("weatherSetPolution",aa);u.listen("common/user_attr","setUserAttr",function(ag){if(ag.attr=="weatherSetPolution"&&ag.state=="setSucc"&&g.g("s_weather_polution_title")&&g.g("s_weather_polution_content")){var af=aa?"inline-block":"none";g.setStyle(g.g("s_weather_polution_title"),"display",af);g.setStyle(g.g("s_weather_polution_content"),"display",af)}})});u.fire("weatherClick",{clickType:"setPolution",setCheckValue:g.g("s_new_weather_psnal_air").checked?"polutionY":"polutionN"});break;case"s_new_weather_psnal_bear":var ad=g.g("s_new_weather_psnal_bear").checked?"on":"off";F.getService("superpage","userAttr",function(ae){ae.setAttr("weatherShowBear",ad)});u.fire("weatherClick",{clickType:"setBear",setCheckValue:g.g("s_new_weather_psnal_bear").checked?"bearY":"bearN"});break;default:return}}})};Y()};var G=function(){var S=["<div class='bottom-detail'>","<span class='weather-pm25-mod-btn'>#{pm25}</span>","<a class='setting-btn' href='#' onclick='return false;' hidefocus>设置</a>","<a class='return-btn' href='#' onclick='return false;' hidefocus><< 返回</a>","</div>"];if(V.today&&V.today.pm25&&+V.today.pm25>0){V.pm25='<a id="new_weather_pm25_level" class="pm25-level" style="float:left" href="'+V.today.pm25url+'" target=_blank>今日空气质量指数(AQI)：<em style="color:#F00">'+V.today.pm25+"</em></a>"}g.q("pnl-bottom",q)[0].innerHTML=g.format(S.join(""),V);var Y=function(){var aa;var Z=g.q("bottom-detail",q)[0];I=g.q("weather-pm25-mod-btn",q)[0];H=g.q("setting-btn",Z)[0],j=g.q("return-btn",Z)[0];g.on(H,"click",function(ab){clearTimeout(aa);aa=setTimeout(function(){T(true)},100);u.fire("weatherClick",{clickType:"settingButton"})});g.on(j,"click",function(ab){N.refresh(function(){clearTimeout(aa);aa=setTimeout(function(){z(true)},100)})});if(g.g("new_weather_pm25_level")){g.on(g.g("new_weather_pm25_level"),"click",function(){u.fire("weatherClick",{clickType:"polutionInLayer"})})}};Y()};var w=function(S){((S&&!g.isIE6)&&m)&&g.setStyle(m,"display","block");g.setStyle(j,"display","inline-block");g.setStyle(H,"display","none");g.setStyle(I,"display","none");if(g.isIE6){return}if(S&&m){new a({duration:1000,trans:"regularEaseOut",from:0,to:365,func:function(){g.setStyle(m,"background-position",this.tween+"px 0px")},ondestroy:function(){g.setStyle(m,"display","none")}})}};var x=function(S){((S&&!g.isIE6)&&m)&&g.setStyle(m,"display","block");g.setStyle(H,"display","inline-block");g.setStyle(j,"display","none");g.setStyle(I,"display","inline-block");if(g.isIE6){return}if(S&&m&&!g.isIE6){new a({duration:1000,trans:"regularEaseOut",from:0,to:365,func:function(){g.setStyle(m,"background-position",this.tween+"px 0px")},ondestroy:function(){g.setStyle(m,"display","none")}})}};var T=function(S){S?w(true):w(false);if(g.browser.isWebkit){g.setStyle(l,"-webkit-transform","scale(2)");g.setStyles(l,{opacity:"0","-khtml-opacity":"0"});g.setStyles(f,{"-webkit-transform":"scale(0.3)",opacity:"0.3","-khtml-opacity":"0.3",display:"block"});setTimeout(function(){g.setStyles(f,{"-webkit-transform":"scale(1)",opacity:"1","-khtml-opacity":"1"})},10)}else{g.setStyle(f,"display","block")}};var z=function(S){S?x(true):x(false);if(g.browser.isWebkit){g.setStyle(f,"-webkit-transform","scale(0.3)");g.setStyles(f,{opacity:"0","-khtml-opacity":"0"});setTimeout(function(){g.setStyle(f,"display","none")},300);setTimeout(function(){g.setStyles(l,{"-webkit-transform":"scale(1)",opacity:"1","-khtml-opacity":"1"})},10)}else{g.setStyle(f,"display","none")}};var M=function(){var S=g.q("s-pk-new-weather",g.g("s_main"))[0];if(!S){return}p=S;V=P.weatherData;var Z=["<div id='s_new_weather_pnl' class='s-new-weather-pnl'>","<div class='s-new-weather-shadow-box'></div>","<div class='s-new-weather-move-bg'></div>","<div class='s-new-weather-move-cell'>","<div class='s-new-weather-move_pnl'>","<div class='pnl-main'>","<div class='pnl-main-detail'>","<div class='pnl-calendar'>","</div>","<div class='weather-detail'>","</div>","</div>","<div class='pnl-main-setting'>","<div class='weather-setting'>","</div>","<div class='pnl-personal-set'>","</div>","</div>","</div>","<div class='pnl-bottom'>","</div>","<div class='s-new-weather-shade-x'></div>","</div>","</div>","</div>"];g.insertHTML(document.body,"beforeEnd",g.format(Z.join(""),V));q=g.g("s_new_weather_pnl");f=g.q("pnl-main-setting",q)[0];l=g.q("pnl-main-detail",q)[0];m=g.q("s-new-weather-shade-x",q)[0];t=g.q("s-new-weather-move_pnl",q)[0];O=g.q("s-new-weather-move-bg",q)[0];R=g.q("s-new-weather-shadow-box",q)[0];D();h();Q();U();G();var Y=function(){if(!V.cityname||V.cityname==""){T()}v=g.getAttr(p.parentNode.parentNode,"data-pkid");o();g.on(q,"mouseover",function(aa){W()});g.on(q,"mouseout",function(aa){e()})};Y()};N.startShow=W;N.startHide=e;N.init=function(S){if(g.g("s_new_weather_pnl")){return}J=S;u.fire("guideShown",{prop:"newWeatherDetail"});M()};N.refresh=function(Y){var S=g.q("s-pk-new-weather",g.g("s_modules"))[0];if(!S){return}var Z=true,aa=v;if(!aa){aa=g.getAttr(S.parentNode.parentNode,"data-pkid");Z=false}g.ajax.get(X+aa,function(ag){p=g.q("s-pk-new-weather",g.g("s_modules"))[0]?g.q("s-pk-new-weather",g.g("s_modules"))[0]:p;var ac=g.q("weather-pollution",p)[0],ae=g.q("weather-aq",p)[0],ak=g.g("s_weather_polution_content"),ah=g.q("new-weather-bear",p.parentNode.parentNode)[0];if(ag.errNo!=0||!ag.data[aa].content.today){g.setStyle(g.q("weather-ok",p)[0],"display","none");g.setStyle(g.q("unknown-city",p)[0],"display","block");g.setStyle(ah,"display","none");if(Z){g.setStyle(q,"display","none");var ad=g.q("pm25-level",q)[0];if(ad){g.setStyle(ad,"display","none")}g.q("weather-detail",q)[0].innerHTML=K}return}g.setStyle(g.q("weather-ok",p)[0],"display","block");V=ag.data[aa].content;J=V.cityname||"自动";if(g.q("unknown-city",p)[0]){g.setStyle(g.q("unknown-city",p)[0],"display","none")}g.q("city-name",p)[0].innerHTML=V.cityname+"：";g.q("weather-today-temp",p)[0].innerHTML=V.today.temp;var ab=new Date(sysTime*1000);if(ab.getHours()>=18&&(V.today.imgs[0]=="a0"||V.today.imgs[0]=="a1")){V.today.imgs[0]=V.today.imgs[0]+"_night"}var ai=V.weatherType?V.weatherType:"png";g.setAttr(g.q("weather-today-img",p)[0],"src","http://1.su.bdimg.com/icon/weather/"+(ai=="png"?"png":(ai+"/png"))+"/"+(V.today.imgs[0]?V.today.imgs[0]:C)+(".png"));g.setAttr(g.q("weather-today-link",p)[0],"href",V.pslink);if(+V.today.pollution<0){g.setStyle(ac,"display","none");g.setStyle(ae,"display","none");g.setStyle(ah,"display","none");g.setStyle(ak,"display","none")}else{ae.className="weather-aq";g.addClass(ae,"new-wearther-air-link");g.addClass(ae,"weather-aq-"+V.today.pollution);ae.innerHTML=P.pollutionLevel[V.today.pollution];F.getService("superpage","userAttr",function(al){if(al.getAttr("weatherSetPolution")=="on"||al.getAttr("weatherSetPolution")+""=="true"){g.setStyle(ae,"display","inline-block");g.setStyle(ac,"display","inline-block");g.setStyle(ak,"display","inline-block")}else{g.setStyle(ac,"display","none");g.setStyle(ae,"display","none");g.setStyle(ak,"display","none")}});g.setAttr(ae,"href",V.today.pm25url);if(+V.today.pollution<30){g.setStyle(ah,"display","none")}else{var af=g.q("new-weather-bear-large",ah)[0],aj=g.q("close-btn-4ie6",ah)[0];af.className="new-weather-bear-large";g.addClass(af,"PACK-CLICK-LOG");g.addClass(af,"bear-large-"+V.today.pollution);F.getService("superpage","userAttr",function(al){if((al.getAttr("weatherShowBear")=="on"||al.getAttr("weatherShowBear")+""=="true")&&+V.today.pollution>=30){F.getService("superpage","localstorage",function(am){var an=am.ls;an.get(B,function(ap,ao){if(ap!=0||(ap==0&&ao!=new Date(sysTime*1000).getDate())){g.setStyle(af,"display","inline-block");if(g.isIE6){g.setStyle(aj,"display","block")}setTimeout(function(){u.fire("guideShown",{prop:"newWeatherBearShow"})},2000);an.set(B,new Date(sysTime*1000).getDate()+"");return}})})}else{g.setStyle(af,"display","none");if(g.isIE6){g.setStyle(aj,"display","none")}}})}}if(!Z){return}D();G();Q();U();h();z();Y&&Y()})}});